<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Ticket</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- LOADING -->
    <div id="view-loading" class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-700">Processing Ticket...</h2>
        <p class="text-sm text-gray-500 mt-2">Connecting to Parking System...</p>
    </div>

    <!-- SUCCESS -->
    <div id="view-success" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-green-500 p-6 text-center">
            <svg class="w-16 h-16 text-white mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <h1 class="text-3xl font-bold text-white">Access Granted</h1>
        </div>
        <div class="p-8 text-center space-y-6">
            <div>
                <p class="text-gray-500 uppercase tracking-wide text-sm font-semibold">Please Park In</p>
                <div id="slot-display" class="text-7xl font-black text-gray-800 mt-2">--</div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-xs text-gray-400 uppercase">Session ID</p>
                <p id="session-display" class="font-mono text-sm text-gray-600 break-all">...</p>
            </div>

            <button onclick="confirmParked()" id="btn-action"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                I'M PARKED
            </button>
        </div>
    </div>

    <!-- ERROR -->
    <div id="view-error" class="hidden w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
        <div class="text-red-500 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Entry Failed</h2>
        <p id="error-msg" class="text-gray-600">Invalid Token</p>

        <button onclick="retryClaim()"
            class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow transition">
            Try Again
        </button>

        <a href="/pwa" class="block mt-4 text-gray-400 text-sm">Go Home</a>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host;
        const params = new URLSearchParams(window.location.search);
        const token = params.get('t');
        const type = params.get('type') || 'entry'; // Default to entry

        function retryClaim() {
            document.getElementById('view-error').classList.add('hidden');
            document.getElementById('view-loading').classList.remove('hidden');
            init();
        }

        async function init() {
            if (!token) {
                showError("No token provided");
                return;
            }

            if (type === 'entry') {
                await claimEntry();
            } else {
                showError("Exit via Web QR not fully supported without app session. Please use the App.");
            }
        }

        async function claimEntry() {
            try {
                // Add 5s timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${API_BASE}/api/claim/entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const text = await res.text();
                try {
                    const data = JSON.parse(text);
                    if (data.ok) {
                        document.getElementById('slot-display').textContent = data.slot;
                        document.getElementById('session-display').textContent = data.session;
                        localStorage.setItem('parking_session', JSON.stringify({ id: data.session, slot: data.slot }));
                        showSuccess();
                    } else {
                        showError(data.reason || data.detail || "Unknown Error");
                    }
                } catch (e) {
                    showError("Server Error: " + text.substring(0, 50));
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    showError("Request Timed Out. Check Network.");
                } else {
                    showError("Network Error: " + e.message);
                }
            }
        }

        async function confirmParked() {
            const sessionText = document.getElementById('session-display').textContent;
            try {
                await fetch(`${API_BASE}/api/session/${sessionText}/confirm_parked`, { method: 'POST' });
                const btn = document.getElementById('btn-action');
                btn.textContent = "ENJOY YOUR STAY";
                btn.className = "w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg cursor-default";
                btn.onclick = null;

                // Add Exit Link
                const exitDiv = document.createElement('div');
                exitDiv.className = "mt-4 pt-4 border-t";
                exitDiv.innerHTML = `<a href="/pwa" class="text-red-500 font-bold">Need to Exit? Open App</a>`;
                document.getElementById('view-success').querySelector('.p-8').appendChild(exitDiv);

            } catch (e) {
                alert("Error confirming");
            }
        }

        function showSuccess() {
            document.getElementById('view-loading').classList.add('hidden');
            document.getElementById('view-success').classList.remove('hidden');
        }

        function showError(msg) {
            document.getElementById('view-loading').classList.add('hidden');
            document.getElementById('view-error').classList.remove('hidden');
            document.getElementById('error-msg').textContent = msg;
        }

        init();
    </script>
</body>

</html>