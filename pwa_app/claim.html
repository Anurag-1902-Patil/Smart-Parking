<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Button Disabled State */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
</head>

<body
    class="bg-gray-900 text-white min-h-[100dvh] flex flex-col items-center justify-center p-6 text-center overflow-hidden relative">

    <!-- DEBUG OVERLAY (Mobile Only) -->
    <div id="debug-overlay"
        class="absolute top-0 left-0 w-full p-2 bg-black/50 text-[10px] text-left font-mono text-green-400 pointer-events-none z-50">
        <div id="debug-status">STATUS: INIT</div>
        <div id="debug-sensor">SENSOR: --</div>
        <div id="debug-gate">GATE: --</div>
        <div id="debug-error" class="text-red-400"></div>
    </div>

    <!-- LOADING STATE -->
    <div id="state-loading" class="space-y-6">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
        <h2 class="text-2xl font-semibold animate-pulse">Checking Access...</h2>
        <p class="text-gray-400 text-sm">Connecting to gate...</p>
    </div>

    <!-- ERROR STATE -->
    <div id="state-error" class="hidden space-y-6 max-w-sm animate-pop">
        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto text-4xl">❌</div>
        <div>
            <h2 class="text-3xl font-bold text-red-500 mb-2">Access Denied</h2>
            <p id="error-msg" class="text-gray-300 text-lg leading-relaxed">Please move closer to the gate sensor.</p>
        </div>
        <button onclick="location.reload()"
            class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95">
            Try Again
        </button>
    </div>

    <!-- SUCCESS ENTRY STATE -->
    <div id="state-success-entry" class="hidden space-y-8 animate-pop w-full max-w-sm">
        <div
            class="w-24 h-24 bg-emerald-500 rounded-full flex items-center justify-center mx-auto text-5xl shadow-lg shadow-emerald-500/30">
            ✅</div>
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">Access Granted</h1>
            <p class="text-emerald-400 font-medium text-lg">Gate Opening...</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
            <p class="text-gray-400 text-sm mb-1">ASSIGNED SLOT</p>
            <div id="slot-id" class="text-6xl font-bold text-white tracking-tighter">--</div>
        </div>
        <p class="text-gray-500 text-sm">Please follow the arrows to your parking spot.</p>

        <a href="index.html"
            class="block w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95">
            Go to Dashboard
        </a>
    </div>

    <!-- EXIT INTENT STATE (NEW) -->
    <div id="state-exit-intent" class="hidden space-y-8 animate-pop w-full max-w-sm">
        <div class="relative">
            <div class="absolute inset-0 bg-blue-500 blur-3xl opacity-20 rounded-full"></div>
            <h1 class="text-3xl font-bold text-white relative">Exit Parking</h1>
        </div>

        <div class="bg-gray-800/50 p-6 rounded-2xl border border-gray-700 backdrop-blur-sm">
            <p id="exit-status-text" class="text-gray-300 text-lg">Please drive to the exit gate</p>
        </div>

        <button id="btn-open-exit" onclick="attemptExit()" disabled
            class="w-full bg-gray-700 text-white font-bold py-6 rounded-2xl transition-all duration-300 shadow-lg flex items-center justify-center space-x-3">
            <span>Open Exit Gate</span>
        </button>

        <p class="text-xs text-gray-500 max-w-[250px] mx-auto">
            Safety: Gate will only open when your car is detected at the exit line.
        </p>
    </div>

    <!-- GATE MONITOR STATE (Legacy/Fallback) -->
    <div id="state-gate-monitor" class="hidden space-y-8 animate-pop w-full max-w-sm">
        <div id="gate-monitor-icon"
            class="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center mx-auto text-5xl shadow-lg shadow-blue-500/30">
            ⚙️</div>
        <div>
            <h1 id="gate-monitor-title" class="text-4xl font-bold text-white mb-2">Gate Opening...</h1>
            <p id="gate-monitor-sub" class="text-blue-400 font-medium text-lg">Please wait</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://' + window.location.hostname + ':8000';
        const WS_URL = 'ws://' + window.location.hostname + ':8000/ws/events';

        const params = new URLSearchParams(window.location.search);
        const token = params.get('t');
        const type = params.get('type'); // 'entry' or 'exit'

        // DOM Elements
        const views = {
            loading: document.getElementById('state-loading'),
            error: document.getElementById('state-error'),
            successEntry: document.getElementById('state-success-entry'),
            exitIntent: document.getElementById('state-exit-intent'),
            gateMonitor: document.getElementById('state-gate-monitor')
        };
        const errorMsg = document.getElementById('error-msg');
        const slotIdEl = document.getElementById('slot-id');

        // Exit Elements
        const btnOpenExit = document.getElementById('btn-open-exit');
        const exitStatusText = document.getElementById('exit-status-text');

        // State
        let socket;
        let isExitBlocked = false;
        let currentSession = localStorage.getItem('parking_session');
        let lastButtonPress = "--";
        let exitProcessActive = false; // Track if we are in the middle of exiting

        // Debug Helper
        function updateDebug(status, error = "") {
            const statusEl = document.getElementById('debug-status');
            const errorEl = document.getElementById('debug-error');

            if (statusEl) statusEl.textContent = "STATUS: " + status;
            if (errorEl && error) errorEl.textContent = "ERR: " + error;

            updateDebugStrip();
        }

        function updateDebugStrip() {
            const sensorEl = document.getElementById('debug-sensor');

            if (sensorEl) sensorEl.textContent = "EXIT IR: " + (isExitBlocked ? "BLOCKED" : "CLEAR");

            let btnStateEl = document.getElementById('debug-btn-state');
            if (!btnStateEl) {
                const overlay = document.getElementById('debug-overlay');
                if (overlay) {
                    btnStateEl = document.createElement('div');
                    btnStateEl.id = 'debug-btn-state';
                    overlay.appendChild(btnStateEl);
                }
            }
            if (btnStateEl) btnStateEl.textContent = "BTN: " + (btnOpenExit.disabled ? "DISABLED" : "ENABLED");

            let lastPressEl = document.getElementById('debug-last-press');
            if (!lastPressEl) {
                const overlay = document.getElementById('debug-overlay');
                if (overlay) {
                    lastPressEl = document.createElement('div');
                    lastPressEl.id = 'debug-last-press';
                    overlay.appendChild(lastPressEl);
                }
            }
            if (lastPressEl) lastPressEl.textContent = "LAST PRESS: " + lastButtonPress;

            let gateEl = document.getElementById('debug-gate');
            if (gateEl && window.lastGateState) gateEl.textContent = "GATE: " + window.lastGateState;
        }

        function showView(viewName) {
            updateDebug(viewName.toUpperCase());
            Object.values(views).forEach(el => {
                if (el) el.classList.add('hidden');
            });
            if (views[viewName]) views[viewName].classList.remove('hidden');
            if (navigator.vibrate) navigator.vibrate(50);

            if (viewName === 'exitIntent') updateExitUI();
        }

        async function init() {
            try {
                updateDebug("INIT_START");

                // Debug Params
                const debugMsg = `T:${type ? type.substring(0, 3) : 'N'} Tok:${token ? 'Y' : 'N'}`;
                const statusEl = document.getElementById('debug-status');
                if (statusEl) statusEl.innerHTML += `<br><span class="text-[8px]">${debugMsg}</span>`;

                // Try WS connection but don't block
                try {
                    connectWebSocket();
                } catch (e) {
                    updateDebug("WS_INIT_FAIL", e.message);
                }

                if (type === 'entry') {
                    if (!token) return showError("Invalid QR Code (No Token)");
                    updateDebug("ENTRY_FLOW");
                    await handleEntry();
                } else {
                    updateDebug("UNKNOWN_TYPE: " + type);
                    showError("Unknown QR Type: " + (type || 'None'));
                }
            } catch (e) {
                updateDebug("CRITICAL_INIT_ERR", e.message);
                showError("App Init Failed: " + e.message);
            }
        }

        function connectWebSocket() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => updateDebug("WS_CONNECTED");
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleWsMessage(msg);
            };
            socket.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        function handleWsMessage(msg) {
            if (msg.type === 'beam_exit') {
                isExitBlocked = (msg.state === 'blocked');
                updateExitUI();
                updateDebugStrip();
            }
            else if (msg.type === 'gate_opened') {
                handleGateState("OPEN");
            }
            else if (msg.type === 'gate_closing') {
                handleGateState("CLOSING");
            }
            else if (msg.type === 'gate_closed') {
                handleGateState("CLOSED");
            }
            else if (msg.type === 'slot_freed') {
                // Exit confirmed!
                localStorage.removeItem('parking_session');
                currentSession = null;
                updateDebug("EXIT_COMPLETE");

                exitStatusText.textContent = "Exit Complete. Safe Travels!";
                exitStatusText.className = "text-emerald-400 text-xl font-bold";
                btnOpenExit.innerHTML = '<span>Exit Complete</span>';
                btnOpenExit.disabled = true;
            }
        }

        async function checkSensors() {
            try {
                const res = await fetch(`${API_BASE}/api/debug/sensors`);
                const data = await res.json();
                isExitBlocked = data.exit;
                updateExitUI();
                updateDebugStrip();
            } catch (e) { }
        }

        function updateExitUI() {
            // If we are already processing an exit (gate opening/open), don't revert UI based on sensors
            if (exitProcessActive) return;

            if (views.exitIntent && views.exitIntent.classList.contains('hidden')) return;

            if (isExitBlocked) {
                btnOpenExit.disabled = false;
                btnOpenExit.classList.remove('bg-gray-700', 'bg-emerald-600', 'bg-gray-800');
                btnOpenExit.classList.add('bg-amber-600');
                btnOpenExit.innerHTML = '<span>Open Exit Gate</span>';

                exitStatusText.textContent = "Ready to Exit";
                exitStatusText.className = "text-emerald-400 text-lg font-bold";
            } else {
                btnOpenExit.disabled = true;
                btnOpenExit.classList.add('bg-gray-700');
                btnOpenExit.classList.remove('bg-amber-600', 'bg-emerald-600');
                btnOpenExit.innerHTML = '<span>Open Exit Gate</span>';

                exitStatusText.textContent = "Please drive to the exit gate";
                exitStatusText.className = "text-amber-400 text-lg animate-pulse";
            }
            updateDebugStrip();
        }

        async function handleEntry() {
            try {
                updateDebug("FETCHING_ENTRY");
                const res = await fetch(`${API_BASE}/api/claim/entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                const data = await res.json();

                if (data.ok) {
                    updateDebug("ENTRY_SUCCESS");
                    slotIdEl.textContent = data.slot;
                    localStorage.setItem('parking_session', data.session);
                    showView('successEntry');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else {
                    showError(data.reason);
                }
            } catch (e) {
                showError("Network Error: " + e.message);
            }
        }

        async function attemptExit() {
            if (!currentSession) return showError("Session Lost");

            lastButtonPress = new Date().toLocaleTimeString();
            updateDebugStrip();

            // Lock UI into Exit Process
            exitProcessActive = true;
            btnOpenExit.disabled = true;
            btnOpenExit.innerHTML = '<span>Exit request sent...</span>';

            try {
                updateDebug("SENDING_EXIT");

                const body = { session: currentSession };
                if (token) body.token = token;

                const res = await fetch(`${API_BASE}/api/claim/exit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (data.ok) {
                    updateDebug("EXIT_ACCEPTED");
                    // Do NOT remove session yet. Wait for slot_freed.
                    handleGateState("OPEN");
                } else {
                    // Revert if failed
                    exitProcessActive = false;
                    updateExitUI();

                    if (data.reason === "WAIT_AT_GATE") {
                        exitStatusText.textContent = "Please drive closer to the gate!";
                        exitStatusText.className = "text-red-400 text-lg font-bold animate-bounce";
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else {
                        showError(data.reason);
                    }
                }
            } catch (e) {
                showError("Network Error: " + e.message);
                exitProcessActive = false;
                updateExitUI();
            }
        }

        function handleGateState(state) {
            window.lastGateState = state;
            updateDebugStrip();

            // Update UI in-place within exitIntent view

            // Ensure we are on the exit view
            if (views.exitIntent && views.exitIntent.classList.contains('hidden')) {
                showView('exitIntent');
            }

            if (state === "OPEN" || state === "OPENING") {
                exitProcessActive = true; // Ensure lock
                btnOpenExit.disabled = true;
                btnOpenExit.classList.remove('bg-amber-600', 'bg-gray-700');
                btnOpenExit.classList.add('bg-emerald-600');
                btnOpenExit.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-2xl">Gate Open</span>
                        <span class="text-sm opacity-90">Please Proceed</span>
                    </div>
                `;

                exitStatusText.textContent = "Have a safe trip!";
                exitStatusText.className = "text-white text-lg font-medium";

                if (navigator.vibrate) navigator.vibrate(100);
            }
            else if (state === "CLOSING") {
                btnOpenExit.innerHTML = '<span>Gate Closing...</span>';
            }
            else if (state === "CLOSED") {
                // Gate Closed -> Reset to "Ready to Exit" state
                // This allows re-trying if the car didn't leave, or handling the next car.
                exitProcessActive = false;

                // Reset Button Appearance
                btnOpenExit.dataset.action = ""; // Clear any special action
                btnOpenExit.classList.remove('bg-emerald-600', 'bg-gray-800', 'border', 'border-gray-600');
                // updateExitUI will handle the rest (disabled/enabled based on sensor)

                updateExitUI();
            }
        }

        function showError(msg) {
            updateDebug("ERROR", msg);
            errorMsg.textContent = msg;
            showView('error');
            if (navigator.vibrate) navigator.vibrate(200);
        }

        init();
    </script>
</body>

</html>