<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="bg-gray-900 text-white min-h-[100dvh] flex flex-col items-center justify-center p-6 text-center overflow-hidden relative">

    <!-- DEBUG OVERLAY (Mobile Only) -->
    <div id="debug-overlay"
        class="absolute top-0 left-0 w-full p-2 bg-black/50 text-[10px] text-left font-mono text-green-400 pointer-events-none z-50">
        <div id="debug-status">STATUS: INIT</div>
        <div id="debug-error" class="text-red-400"></div>
    </div>

    <!-- LOADING STATE -->
    <div id="state-loading" class="space-y-6">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
        <h2 class="text-2xl font-semibold animate-pulse">Checking Access...</h2>
        <p class="text-gray-400 text-sm">Connecting to gate...</p>
    </div>

    <!-- ERROR STATE -->
    <div id="state-error" class="hidden space-y-6 max-w-sm animate-pop">
        <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto text-4xl">‚ùå</div>
        <div>
            <h2 class="text-3xl font-bold text-red-500 mb-2">Access Denied</h2>
            <p id="error-msg" class="text-gray-300 text-lg leading-relaxed">Please move closer to the gate sensor.</p>
        </div>
        <button onclick="location.reload()"
            class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95">
            Try Again
        </button>
    </div>

    <!-- SUCCESS ENTRY STATE -->
    <div id="state-success-entry" class="hidden space-y-8 animate-pop w-full max-w-sm">
        <div
            class="w-24 h-24 bg-emerald-500 rounded-full flex items-center justify-center mx-auto text-5xl shadow-lg shadow-emerald-500/30">
            ‚úÖ</div>
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">Access Granted</h1>
            <p class="text-emerald-400 font-medium text-lg">Gate Opening...</p>
        </div>

        <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 shadow-xl">
            <p class="text-gray-400 text-sm uppercase tracking-widest mb-2">Your Slot</p>
            <div id="slot-id" class="text-8xl font-black text-white tracking-tighter">--</div>
        </div>

        <p class="text-gray-500 text-sm">Please follow the arrows to your parking spot.</p>
    </div>

    <!-- SUCCESS EXIT STATE -->
    <div id="state-success-exit" class="hidden space-y-8 animate-pop w-full max-w-sm">
        <div
            class="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center mx-auto text-5xl shadow-lg shadow-blue-500/30">
            üëã</div>
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">Have a safe trip!</h1>
            <p class="text-blue-400 font-medium text-lg">Gate Opening...</p>
        </div>
        <div class="bg-gray-800/50 rounded-xl p-6">
            <p class="text-gray-400">Thank you for visiting.</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://' + window.location.hostname + ':8000';
        const params = new URLSearchParams(window.location.search);
        const token = params.get('t');
        const type = params.get('type'); // 'entry' or 'exit'

        // DOM Elements
        const views = {
            loading: document.getElementById('state-loading'),
            error: document.getElementById('state-error'),
            successEntry: document.getElementById('state-success-entry'),
            successExit: document.getElementById('state-success-exit')
        };
        const errorMsg = document.getElementById('error-msg');
        const slotIdEl = document.getElementById('slot-id');

        // Debug Helper
        function updateDebug(status, error = "") {
            document.getElementById('debug-status').textContent = "STATUS: " + status;
            if (error) document.getElementById('debug-error').textContent = "ERR: " + error;
        }

        function showView(viewName) {
            updateDebug(viewName.toUpperCase());
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            if (navigator.vibrate) navigator.vibrate(50);
        }

        async function init() {
            updateDebug("INIT_START");
            if (!token) return showError("Invalid QR Code (No Token)");

            if (type === 'entry') {
                updateDebug("ENTRY_FLOW");
                await handleEntry();
            } else if (type === 'exit') {
                updateDebug("EXIT_FLOW");
                await handleExit();
            } else {
                showError("Unknown QR Type");
            }
        }

        async function handleEntry() {
            try {
                updateDebug("FETCHING_ENTRY");
                const res = await fetch(`${API_BASE}/api/claim/entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                const data = await res.json();

                if (data.ok) {
                    updateDebug("ENTRY_SUCCESS");
                    slotIdEl.textContent = data.slot;
                    localStorage.setItem('parking_session', data.session);
                    showView('successEntry');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else {
                    showError(data.reason);
                }
            } catch (e) {
                showError("Network Error: " + e.message);
            }
        }

        async function handleExit() {
            const session = localStorage.getItem('parking_session');
            if (!session) return showError("No active parking session found.");

            // Try to claim exit immediately
            await attemptExit(token, session);
        }

        async function attemptExit(token, session) {
            try {
                updateDebug("FETCHING_EXIT");
                const res = await fetch(`${API_BASE}/api/claim/exit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, session: session })
                });
                const data = await res.json();

                if (data.ok) {
                    updateDebug("EXIT_SUCCESS");
                    localStorage.removeItem('parking_session');
                    showView('successExit');
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else {
                    showError(data.reason);
                }
            } catch (e) {
                showError("Network Error: " + e.message);
            }
        }

        function showError(msg) {
            updateDebug("ERROR", msg);
            errorMsg.textContent = msg;
            showView('error');
            if (navigator.vibrate) navigator.vibrate(200);
        }

        // Start immediately
        init();
    </script>
</body>

</html>