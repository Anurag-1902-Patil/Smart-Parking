<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-[100dvh] flex flex-col relative">

    <!-- DEBUG OVERLAY (Mobile Only) -->
    <div id="debug-overlay"
        class="absolute top-0 left-0 w-full p-2 bg-black/50 text-[10px] text-left font-mono text-green-400 pointer-events-none z-50">
        <div id="debug-status">STATUS: INIT</div>
        <div id="debug-sensor">SENSOR: --</div>
        <div id="debug-gate">GATE: --</div>
        <div id="debug-error" class="text-red-400"></div>
    </div>

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-10">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <h1 class="text-lg font-bold text-gray-900">Smart Parking</h1>
            <div id="status-badge"
                class="hidden px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full uppercase tracking-wide">
                Parked
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-6 flex flex-col items-center justify-center max-w-md mx-auto w-full space-y-6">

        <!-- VIEW: SCANNER -->
        <div id="view-scan" class="w-full space-y-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
                <div class="relative aspect-square bg-gray-900 rounded-xl overflow-hidden mb-4">
                    <canvas id="canvas" class="w-full h-full object-cover"></canvas>
                    <div id="camera-loading"
                        class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                        Starting Camera...
                    </div>
                    <!-- Scan Overlay -->
                    <div class="absolute inset-0 border-2 border-white/30 m-8 rounded-lg pointer-events-none">
                        <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-emerald-500 -mt-1 -ml-1">
                        </div>
                        <div
                            class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-emerald-500 -mt-1 -mr-1">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-emerald-500 -mb-1 -ml-1">
                        </div>
                        <div
                            class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-emerald-500 -mb-1 -mr-1">
                        </div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-center text-gray-900 mb-1">Scan to Enter</h2>
                <p class="text-center text-gray-500 text-sm">Point your camera at the Entry QR code</p>
            </div>
        </div>

        <!-- VIEW: PARKED DASHBOARD -->
        <div id="view-parked" class="hidden w-full space-y-6 animate-pop">
            <!-- Slot Card -->
            <div
                class="bg-emerald-500 rounded-2xl p-8 text-center text-white shadow-lg shadow-emerald-500/20 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                <p class="text-emerald-100 uppercase tracking-widest text-sm font-semibold mb-2 relative z-10">You are
                    parked in</p>
                <div id="assigned-slot" class="text-8xl font-black mb-2 relative z-10">--</div>
                <div class="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-mono relative z-10">
                    Session: <span id="session-id">...</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 space-y-4">
                <h3 class="font-bold text-gray-900">Ready to leave?</h3>
                <p class="text-gray-500 text-sm">Drive to the exit gate and tap the button below.</p>

                <button onclick="switchToExitMode()"
                    class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Exit Parking
                </button>
            </div>
        </div>

        <!-- VIEW: EXIT INTENT (Merged from claim.html) -->
        <div id="view-exit" class="hidden w-full space-y-6 animate-pop">
            <div class="bg-gray-900 text-white p-8 rounded-3xl shadow-2xl space-y-8">
                <div class="w-20 h-20 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto text-4xl">
                    üöó</div>
                <div>
                    <h1 class="text-3xl font-bold mb-2">Exit Parking</h1>
                    <p id="exit-status-text" class="text-gray-400 text-lg">Checking sensors...</p>
                </div>

                <button id="btn-open-exit" disabled onclick="attemptExit()"
                    class="w-full bg-amber-600 hover:bg-amber-500 disabled:bg-gray-700 text-white font-bold py-6 rounded-2xl text-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span>Open Exit Gate</span>
                </button>

                <p class="text-xs text-gray-500">Button enables when you are at the gate.</p>

                <button onclick="cancelExit()" class="text-gray-500 text-sm underline">Cancel</button>
            </div>
        </div>

        <!-- VIEW: ERROR -->
        <div id="view-error" class="hidden w-full space-y-6 animate-pop text-center">
            <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto text-4xl">‚ùå</div>
            <h2 class="text-2xl font-bold text-red-600">Error</h2>
            <p id="error-msg" class="text-gray-600">Something went wrong.</p>
            <button onclick="location.reload()" class="bg-gray-200 px-6 py-3 rounded-xl font-bold">Reload</button>
        </div>

    </main>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':8000';
        const WS_URL = 'ws://' + window.location.hostname + ':8000/ws/events';

        // State
        let video = document.createElement("video");
        let canvasElement = document.getElementById("canvas");
        let canvas = canvasElement.getContext("2d");
        let scanning = true;
        let currentSession = localStorage.getItem('parking_session');
        let socket;
        let isExitBlocked = false;
        let exitProcessActive = false;

        // DOM
        const views = {
            scan: document.getElementById('view-scan'),
            parked: document.getElementById('view-parked'),
            exit: document.getElementById('view-exit'),
            error: document.getElementById('view-error')
        };
        const statusBadge = document.getElementById('status-badge');
        const cameraLoading = document.getElementById('camera-loading');

        // Exit Elements
        const btnOpenExit = document.getElementById('btn-open-exit');
        const exitStatusText = document.getElementById('exit-status-text');

        function init() {
            updateDebug("INIT");
            connectWebSocket();

            // Check for URL params (Direct Entry/Exit)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (currentSession) {
                showParkedView(JSON.parse(currentSession));
            }
            else if (token) {
                // Direct Entry via QR
                console.log("Direct Entry Token:", token);
                scanning = false; // Disable scanner
                views.scan.classList.add('hidden'); // Hide scanner immediately

                // Show temporary loading state
                showError("Processing Entry...");
                const errDiv = document.getElementById('view-error');
                errDiv.querySelector('h2').innerText = "Entering...";
                errDiv.querySelector('h2').className = "text-2xl font-bold text-emerald-600";
                errDiv.querySelector('div').innerText = "‚è≥";

                handleEntry(token);
            }
            else {
                startScanner();
            }
        }

        // --- NAVIGATION ---
        function showView(name) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[name].classList.remove('hidden');

            if (name === 'parked') statusBadge.classList.remove('hidden');
            else statusBadge.classList.add('hidden');

            if (name === 'exit') updateExitUI();
        }

        function switchToExitMode() {
            updateDebug("EXIT_MODE");
            showView('exit');
            checkSensors();
        }

        function cancelExit() {
            showView('parked');
        }

        // --- SCANNER LOGIC ---
        function startScanner() {
            scanning = true;
            showView('scan');

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            });
        }

        function tick() {
            if (!scanning) return;
            if (views.scan.classList.contains('hidden')) {
                scanning = false;
                return;
            }

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                cameraLoading.classList.add('hidden');
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) handleScan(code.data);
            }
            requestAnimationFrame(tick);
        }

        function handleScan(data) {
            if (data.startsWith('http')) {
                // If it's a claim link, parse it manually to avoid navigation
                try {
                    const url = new URL(data);
                    const t = url.searchParams.get('t');
                    if (t) {
                        scanning = false;
                        handleEntry(t);
                        return;
                    }
                } catch (e) { }

                // Fallback
                window.location.href = data;
                return;
            }
        }

        async function handleEntry(token) {
            try {
                updateDebug("CLAIMING_ENTRY");
                const res = await fetch(`${API_BASE}/api/claim/entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                const data = await res.json();

                if (data.ok) {
                    localStorage.setItem('parking_session', JSON.stringify({ id: data.session, slot: data.slot }));
                    currentSession = localStorage.getItem('parking_session');
                    showParkedView(JSON.parse(currentSession));
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                } else {
                    showError(data.reason);
                }
            } catch (e) {
                showError("Network Error: " + e.message);
            }
        }

        function showParkedView(session) {
            scanning = false;
            showView('parked');

            let s = session;
            if (typeof session === 'string') s = { slot: '?', id: session };

            document.getElementById('assigned-slot').textContent = s.slot || '?';
            document.getElementById('session-id').textContent = (s.id || '').substring(0, 8);
        }

        // --- EXIT LOGIC ---
        function connectWebSocket() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => updateDebug("WS_CONNECTED");
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleWsMessage(msg);
            };
            socket.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        function handleWsMessage(msg) {
            if (msg.type === 'beam_exit') {
                isExitBlocked = (msg.state === 'blocked');
                updateExitUI();
            }
            else if (msg.type === 'gate_opened') handleGateState("OPEN");
            else if (msg.type === 'gate_closing') handleGateState("CLOSING");
            else if (msg.type === 'gate_closed') handleGateState("CLOSED");
        }

        async function checkSensors() {
            try {
                const res = await fetch(`${API_BASE}/api/debug/sensors`);
                const data = await res.json();
                isExitBlocked = data.exit;
                updateExitUI();
            } catch (e) { }
        }

        function updateExitUI() {
            if (exitProcessActive) return;
            if (views.exit.classList.contains('hidden')) return;

            updateDebug("EXIT_UI_UPDATE: " + isExitBlocked);

            if (isExitBlocked) {
                btnOpenExit.disabled = false;
                btnOpenExit.classList.remove('bg-gray-700', 'bg-emerald-600', 'bg-gray-800');
                btnOpenExit.classList.add('bg-amber-600');
                btnOpenExit.innerHTML = '<span>Open Exit Gate</span>';

                exitStatusText.textContent = "Ready to Exit";
                exitStatusText.className = "text-emerald-400 text-lg font-bold";
            } else {
                btnOpenExit.disabled = true;
                btnOpenExit.classList.add('bg-gray-700');
                btnOpenExit.classList.remove('bg-amber-600', 'bg-emerald-600');
                btnOpenExit.innerHTML = '<span>Open Exit Gate</span>';

                exitStatusText.textContent = "Please drive to the exit gate";
                exitStatusText.className = "text-amber-400 text-lg animate-pulse";
            }
            updateDebugStrip();
        }

        async function attemptExit() {
            // "Go Home" Action
            if (btnOpenExit.dataset.action === "home") {
                localStorage.removeItem('parking_session');
                currentSession = null;
                exitProcessActive = false;
                // Reset UI state
                btnOpenExit.dataset.action = "";
                startScanner();
                return;
            }

            // Check if session exists before attempting exit
            if (!currentSession) {
                showError("Session Lost - Please restart the app");
                return;
            }

            // Exit API Call
            let sessionId = currentSession;
            try {
                let parsed = JSON.parse(currentSession);
                sessionId = parsed.id || parsed;
            } catch (e) {
                // Already a string, use as-is
            }

            lastButtonPress = new Date().toLocaleTimeString();
            updateDebugStrip();

            exitProcessActive = true;
            btnOpenExit.disabled = true;
            btnOpenExit.innerHTML = '<span>Sending exit request...</span>';

            try {
                updateDebug("SENDING_EXIT");
                const res = await fetch(`${API_BASE}/api/claim/exit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session: sessionId })
                });
                const data = await res.json();

                if (data.ok) {
                    updateDebug("EXIT_ACCEPTED");
                    handleGateState("OPEN");
                } else {
                    exitProcessActive = false;
                    updateExitUI();
                    if (data.reason === "WAIT_AT_GATE") {
                        exitStatusText.textContent = "Please drive closer to the gate!";
                        exitStatusText.className = "text-red-400 text-lg font-bold animate-bounce";
                    } else {
                        // Handle both custom 'reason' and FastAPI 'detail'
                        const errorText = data.reason || data.detail || JSON.stringify(data);
                        showError(errorText);
                    }
                }
            } catch (e) {
                showError("Network Error: " + e.message);
                exitProcessActive = false;
                updateExitUI();
            }
        }

        function handleGateState(state) {
            window.lastGateState = state;
            updateDebugStrip();

            if (views.exit.classList.contains('hidden')) return;

            if (state === "OPEN" || state === "OPENING") {
                exitProcessActive = true;
                btnOpenExit.disabled = true;
                btnOpenExit.classList.remove('bg-amber-600', 'bg-gray-700');
                btnOpenExit.classList.add('bg-emerald-600');
                btnOpenExit.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-2xl">Gate Open</span>
                        <span class="text-sm opacity-90">Please Proceed</span>
                    </div>
                `;
                exitStatusText.textContent = "Have a safe trip!";
                exitStatusText.className = "text-white text-lg font-medium";
                if (navigator.vibrate) navigator.vibrate(100);
            }
            else if (state === "CLOSING") {
                btnOpenExit.innerHTML = '<span>Gate Closing...</span>';
            }
            else if (state === "CLOSED") {
                exitProcessActive = true;
                btnOpenExit.disabled = false;
                btnOpenExit.dataset.action = "home";
                btnOpenExit.classList.remove('bg-emerald-600', 'bg-amber-600');
                btnOpenExit.classList.add('bg-gray-800', 'border', 'border-gray-600');
                btnOpenExit.innerHTML = '<span>Exit Complete ‚Ä¢ Go Home</span>';

                exitStatusText.textContent = "Thank you for visiting!";
                exitStatusText.className = "text-emerald-400 text-xl font-bold";
            }
        }

        // --- DEBUG ---
        function updateDebug(status, error = "") {
            const statusEl = document.getElementById('debug-status');
            const errorEl = document.getElementById('debug-error');
            if (statusEl) statusEl.textContent = "STATUS: " + status;
            if (errorEl && error) errorEl.textContent = "ERR: " + error;
            updateDebugStrip();
        }

        function updateDebugStrip() {
            const sensorEl = document.getElementById('debug-sensor');
            if (sensorEl) sensorEl.textContent = "EXIT IR: " + (isExitBlocked ? "BLOCKED" : "CLEAR");

            let gateEl = document.getElementById('debug-gate');
            if (gateEl && window.lastGateState) gateEl.textContent = "GATE: " + window.lastGateState;
        }

        function showError(msg) {
            document.getElementById('error-msg').textContent = msg;
            showView('error');
        }

        init();
    </script>
</body>

</html>